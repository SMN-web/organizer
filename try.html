<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Firebase Email Worker Test</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #fbfbfb; }
    .testbox { max-width: 420px; margin: 3em auto; background: #fff; border-radius: 9px; box-shadow: 0 4px 12px #e4e4e4; padding: 2em;}
    .error { color: #b71c1c }
    .success { color: #168819 }
  </style>
</head>
<body>
  <div class="testbox" id="main">
    <h2>Email/Password Login (Test)</h2>
    <div id="loginSection">
      <form id="loginForm">
        <label>Email: <input type="email" id="loginEmail" required></label><br>
        <label>Password: <input type="password" id="loginPassword" required></label><br>
        <button type="submit">Sign In</button>
      </form>
      <div class="error" id="loginError"></div>
    </div>
    <div id="authSection" style="display:none;">
      <div class="success" id="userMsg"></div>
      <textarea id="userToken" style="width:100%;height:5em;" readonly></textarea>
      <button id="fetchEmailBtn">Send Token to Worker</button>
      <div id="workerResult" style="margin-top:1em;font-size:1.1em;"></div>
      <button onclick="firebase.auth().signOut().then(()=>location.reload())" style="margin-top:1em;">Sign out</button>
    </div>
  </div>
  <script>
    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAWphaG1_4n1i3F9kY_TrMdvjVQomu7OtQ",
  authDomain: "organizer-359e3.firebaseapp.com",
  projectId: "organizer-359e3",
  storageBucket: "organizer-359e3.firebasestorage.app",
  messagingSenderId: "223125946708",
  appId: "1:223125946708:web:17850e13399725533288c1",
  measurementId: "G-R9GMNJ5Q7T"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    document.getElementById('loginForm').onsubmit = async function(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      document.getElementById('loginError').textContent = "";
      try {
        await firebase.auth().signInWithEmailAndPassword(email, password);
        showAuthSection();
      } catch (err) {
        document.getElementById('loginError').textContent = err.message;
      }
    };

    function showAuthSection() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('authSection').style.display = '';
      const user = firebase.auth().currentUser;
      document.getElementById('userMsg').textContent = "Signed in as " + user.email;
      user.getIdToken(true).then(token => {
        document.getElementById('userToken').value = token;
        document.getElementById('fetchEmailBtn').onclick = function() {
          document.getElementById('workerResult').textContent = "Checking with worker...";
          fetch('https://try.nafil-8895-s.workers.dev/api/verify-email', {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token }
          }).then(res => res.json()).then(data => {
            if (data.email) {
              document.getElementById('workerResult').innerHTML =
                "<span class='success'>Worker verified email: " + data.email + "</span>";
            } else {
              document.getElementById('workerResult').innerHTML =
                "<span class='error'>Worker error: " + (data.error||'Unknown') + "</span>";
            }
          }).catch(e => {
            document.getElementById('workerResult').innerHTML =
              "<span class='error'>Worker call failed</span>";
          });
        };
      });
    }

    firebase.auth().onAuthStateChanged(function(user) {
      if (user) showAuthSection();
    });
  </script>
</body>
</html>
