<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Firebase Auth Demo</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAWphaG1_4n1i3F9kY_TrMdvjVQomu7OtQ",
      authDomain: "organizer-359e3.firebaseapp.com",
      projectId: "organizer-359e3",
      storageBucket: "organizer-359e3.firebasestorage.app",
      messagingSenderId: "223125946708",
      appId: "1:223125946708:web:17850e13399725533288c1",
      measurementId: "G-R9GMNJ5Q7T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const appDiv = document.getElementById('app');

    function showLogin() {
      appDiv.innerHTML = `
        <div style="max-width:360px;margin:3em auto;padding:2em;border-radius:16px;background:#fff;">
          <h2>Login</h2>
          <form id="loginForm">
            <input type="email" id="email" placeholder="Email" required style="width:100%;margin-bottom:1em;padding:0.8em;">
            <input type="password" id="password" placeholder="Password" required style="width:100%;margin-bottom:1em;padding:0.8em;">
            <button type="submit" style="padding:0.7em 2.5em;">Sign In</button>
          </form>
          <div id="loginMsg" style="color:#e74c3c;margin-top:1em;"></div>
        </div>
      `;
      document.getElementById('loginForm').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const msgDiv = document.getElementById('loginMsg');
        msgDiv.textContent = '';
        try {
          const cred = await signInWithEmailAndPassword(auth, email, password);
          const token = await cred.user.getIdToken(true);
          // Optionally store email/token in localStorage for demo purpose
          localStorage.setItem('auth_email', email);
          localStorage.setItem('auth_token', token);
          showDashboard();
        } catch (err) {
          msgDiv.textContent = err.message || "Login failed";
        }
      };
    }

    function showDashboard() {
      appDiv.innerHTML = `
        <div style="max-width:400px;margin:3em auto;padding:2em;border-radius:16px;background:#eaf7ff;">
          <h2>Welcome, ${localStorage.getItem('auth_email') || ''}</h2>
          <button id="logoutBtn" style="padding:0.6em 2em;margin-bottom:1em;">Logout</button>
          <button id="fetchBtn" style="padding:0.6em 2em;margin-left:1em;">Fetch Session Status</button>
          <div id="resultBox" style="margin-top:2em;background:#fff;border-radius:6px;padding:1em;"></div>
        </div>
      `;
      document.getElementById('logoutBtn').onclick = async () => {
        await signOut(auth);
        localStorage.removeItem('auth_email');
        localStorage.removeItem('auth_token');
        showLogin();
      };
      document.getElementById('fetchBtn').onclick = async () => {
        const user = auth.currentUser;
        const resultBox = document.getElementById('resultBox');
        if (!user) {
          resultBox.innerHTML = "<span style='color:#c00'>Not signed in.</span>";
          return;
        }
        resultBox.innerHTML = "<span>Loading...</span>";
        try {
          const token = await user.getIdToken(true);
          // Show token for demo
          localStorage.setItem('auth_token', token);
          // Call backend /api/session-status
          const resp = await fetch('https://session.nafil-8895-s.workers.dev/api/session-status', {
            headers: { "Authorization": "Bearer " + token }
          });
          if (!resp.ok) {
            const text = await resp.text();
            resultBox.innerHTML = `<div style="color:#c00">Error [${resp.status}]:<br>${text}</div>`;
            return;
          }
          const data = await resp.json();
          resultBox.innerHTML = `
            <div><b>Session Info:</b></div>
            <pre style="margin-top:1em;background:#f7f7f7;padding:1em;border-radius:8px;">${JSON.stringify(data, null, 2)}</pre>
          `;
        } catch (err) {
          resultBox.innerHTML = `<div style="color:#c00">${err && err.message ? err.message : err}</div>`;
        }
      };
    }

    // On page load or auth state change, restore dashboard if signed in
    auth.onAuthStateChanged(user => {
      if (user) {
        localStorage.setItem('auth_email', user.email);
        showDashboard();
      } else {
        showLogin();
      }
    });

    // Initial load for single-page app
    window.onload = () => {
      if (auth.currentUser) showDashboard();
      else showLogin();
    };
  </script>
  <style>
    body { background:#f4f4f7; font-family:sans-serif; }
  </style>
</head>
<body>
  <div id="app"></div>
</body>
</html>
