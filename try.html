<!DOCTYPE html>
<html lang="en">
<head>
  <title>Profile Photo Upload Demo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>
</head>
<body>
  <h2>Sign In</h2>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button id="signInBtn">Sign In</button>
  <div id="authStatus"></div>

  <h2>Upload Profile Photo</h2>
  <input type="file" id="photoInput" accept="image/*">
  <button id="uploadPhotoBtn">Upload Photo</button>
  <div id="uploadStatus"></div>

  <h2>Show Profile Photo</h2>
  <button id="showPhotoBtn">Show Image</button>
  <div id="profilePhoto"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWphaG1_4n1i3F9kY_TrMdvjVQomu7OtQ",
  authDomain: "organizer-359e3.firebaseapp.com",
  projectId: "organizer-359e3",
  storageBucket: "organizer-359e3.firebasestorage.app",
  messagingSenderId: "223125946708",
  appId: "1:223125946708:web:17850e13399725533288c1",
  measurementId: "G-R9GMNJ5Q7T"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // --- Sign-in handler ---
  document.getElementById('signInBtn').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    try {
      await signInWithEmailAndPassword(auth, email, password);
      document.getElementById('authStatus').textContent = "Signed in!";
    } catch (e) {
      document.getElementById('authStatus').textContent = "Sign-in error: " + e.message;
    }
  };

  // --- Upload photo handler ---
  document.getElementById('uploadPhotoBtn').onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
      document.getElementById('uploadStatus').textContent = "Sign in first!";
      return;
    }
    const photoFile = document.getElementById('photoInput').files[0];
    if (!photoFile) {
      document.getElementById('uploadStatus').textContent = "Choose a photo file first!";
      return;
    }
    try {
      const storageRef = ref(storage, `avatars/${user.uid}.jpg`);
      await uploadBytes(storageRef, photoFile);
      const imageUrl = await getDownloadURL(storageRef);
      document.getElementById('uploadStatus').textContent = "Uploaded!";
      // Save image url to backend
      const token = await user.getIdToken();
      const resp = await fetch("https://try.nafil-8895-s.workers.dev/api/user/avatar", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ imageUrl })
      });
      if (!resp.ok) throw new Error(await resp.text());
      document.getElementById('uploadStatus').textContent = "Saved imageURL to database!";
    } catch (e) {
      document.getElementById('uploadStatus').textContent = "Error: " + e.message;
    }
  };

  // --- Show photo handler ---
  document.getElementById('showPhotoBtn').onclick = async () => {
    const user = auth.currentUser;
    const profileDiv = document.getElementById('profilePhoto');
    profileDiv.innerHTML = "";
    if (!user) {
      profileDiv.textContent = "Sign in first!";
      return;
    }
    try {
      const token = await user.getIdToken();
      const resp = await fetch("https://try.nafil-8895-s.workers.dev/api/user/avatar", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!resp.ok) throw new Error(await resp.text());
      const data = await resp.json();
      if (!data.imageURL) {
        profileDiv.textContent = "You have no profile image uploaded!";
        return;
      }
      profileDiv.innerHTML = `<img src="${data.imageURL}" style="width:110px;height:110px;border-radius:50%;border:2px solid #ccc;">`;
    } catch (e) {
      profileDiv.textContent = "Error: " + e.message;
    }
  };
</script>
</body>
</html>
