<!DOCTYPE html>
<html lang="en">
<head>
  <title>Profile Photo Upload Demo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>
</head>
<body>
  <h2>Sign In</h2>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button id="signInBtn">Sign In</button>
  <div id="authStatus"></div>

  <h2>Upload Profile Photo</h2>
  <input type="file" id="photoInput" accept="image/*">
  <button id="uploadPhotoBtn">Upload Photo</button>
  <div id="uploadStatus"></div>

  <h2>Show Profile Photo</h2>
  <button id="showPhotoBtn">Show Image</button>
  <div id="profilePhoto"></div>

<script type="module">
  // --- 1. Firebase setup ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    // ...rest config
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // --- 2. Sign-in ---
  document.getElementById('signInBtn').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    try {
      await signInWithEmailAndPassword(auth, email, password);
      document.getElementById('authStatus').textContent = "Signed in!";
    } catch (e) {
      document.getElementById('authStatus').textContent = "Sign-in error: " + e.message;
    }
  };

  // --- 3. Upload photo ---
  document.getElementById('uploadPhotoBtn').onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
      document.getElementById('uploadStatus').textContent = "Sign in first!";
      return;
    }
    const photoFile = document.getElementById('photoInput').files[0];
    if (!photoFile) {
      document.getElementById('uploadStatus').textContent = "Choose a file!";
      return;
    }
    try {
      const storageRef = ref(storage, `avatars/${user.uid}.jpg`);
      await uploadBytes(storageRef, photoFile);
      const imageUrl = await getDownloadURL(storageRef);
      document.getElementById('uploadStatus').textContent = "Uploaded!";
      // Call Worker to save imageUrl in users table
      const token = await user.getIdToken();
      const resp = await fetch("https://try.nafil-8895-s.workers.dev/api/user/avatar", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ uid: user.uid, imageUrl })
      });
      if (!resp.ok) throw new Error(await resp.text());
      document.getElementById('uploadStatus').textContent = "Saved imageURL to database!";
    } catch (e) {
      document.getElementById('uploadStatus').textContent = "Error: " + e.message;
    }
  };

  // --- 4. Show photo (fetch imageURL from Worker, then display) ---
  document.getElementById('showPhotoBtn').onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
      document.getElementById('profilePhoto').textContent = "Sign in first!";
      return;
    }
    try {
      const token = await user.getIdToken();
      const resp = await fetch("https://try.nafil-8895-s.workers.dev/api/user/avatar?uid=" + user.uid, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!resp.ok) throw new Error(await resp.text());
      const data = await resp.json();
      if (!data.imageUrl) {
        document.getElementById('profilePhoto').textContent = "No image found!";
        return;
      }
      document.getElementById('profilePhoto').innerHTML = `<img src="${data.imageUrl}" style="width:110px;height:110px;border-radius:50%;">`;
    } catch (e) {
      document.getElementById('profilePhoto').textContent = "Error: " + e.message;
    }
  };
</script>
</body>
</html>
